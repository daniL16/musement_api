name: Tests
on:
  - push

jobs:
    docker-build:
      name: Docker build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2
        - name: PHP syntax checker 7.3
          uses: overtrue/phplint@3.0.2
          with:
            path: ./api/
            options: --exclude=*.log
            warning: true
        - name: Pull images
          run: docker-compose pull
        - name: Start services
          run: make build
        - name: Wait for services
          run: |
              while status="$(docker inspect --format="{{if .Config.Healthcheck}}{{print .State.Health.Status}}{{end}}" "$(docker-compose ps -q php)")"; do
                case $status in
                  starting) sleep 1;;
                  healthy) exit 0;;
                  unhealthy) exit 1;;
                esac
              done
              exit 1
        - name: Run tests
          run: make tests
